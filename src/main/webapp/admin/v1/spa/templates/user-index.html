<!-- Main row -->
<div class="row">
	<!-- Left col -->
	<section class="col-lg-12 connectedSortable">
		<!-- /.box -->
		<div class="box box-solid">
			<div class="box-header">
				<div class="pull-right form-inline">
					<div class="form-group">
						<div class="col-sm-7" style="padding-right: 5%;">
							<form method="POST" action="">
								<div class="input-group">
									<select class="form-control" name="roles_id">
										<option selected value="1"></option>
									</select>
									<div class="input-group-btn">
										<button type="submit" class="btn btn-info btn-flat">Action</button>
									</div>
								</div>
							</form>
						</div>
						<div class="col-sm-5 text-right text-left-customize-mobile"
							style="padding-left: 0%; padding-right: 0%;">
							<div class="btn-group">
								<button type="button"
									class="btn btn-success btn-sm dropdown-toggle"
									data-toggle="dropdown">
									<i class="fa fa-bars"></i>
								</button>
								<ul class="dropdown-menu pull-right" role="menu">
									<li><a href="#" data-toggle="modal" data-target="#myModal"
										class="buttonClose">Add new menu</a></li>
									<li class="divider"></li>
									<li><a href="#">View calendar</a></li>
								</ul>
							</div>
							<button type="button" class="btn btn-success btn-sm"
								data-widget="collapse">
								<i class="fa fa-minus"></i>
							</button>
							<button type="button" class="btn btn-success btn-sm"
								data-widget="remove">
								<i class="fa fa-times"></i>
							</button>
						</div>
					</div>

				</div>
				<!-- /. tools -->
			</div>
			<div class="box-body">
				<!-- /.box-header -->
				<div class="box-body">
					<table id="tableUser" class="table table-bordered table-striped">
						<thead>
							<tr>
								<th><div class="center">No</div></th>
								<th><div class="center">Id</div></th>
								<th><div class="center">Create Time</div></th>
								<th><div class="center">Modify Time</div></th>
								<th><div class="center">User Name</div></th>
								<th><div class="center">Name</div></th>
								<th><div class="center">Email</div></th>
								<th><div class="center">No Hp</div></th>
								<th><div class="center">Roles</div></th>
								<th><div class="center">Is Active</div></th>
								<th><div class="center">Action</div></th>
							</tr>
						</thead>
						<tbody>
						</tbody>
					</table>
				</div>
				<!-- /.box-body -->
			</div>
		</div>
	</section>
</div>
<!-- /.row (main row) -->

<div id="modalDeleteUser" class="modal modal-danger" role="dialog">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal"
					aria-label="Close">
					<span aria-hidden="true">&times;</span>
				</button>
				<h4 class="modal-title">Warning</h4>
			</div>
			<div class="modal-body">
				<p>Are you sure delete this data ?</p>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-outline pull-left"
					data-dismiss="modal">Cancel</button>
				<button type="button" id="deleteUser" class="btn btn-outline">Delete</button>
			</div>
		</div>
		<!-- /.modal-content -->
	</div>
	<!-- /.modal-dialog -->
</div>

<!-- Modal -->
<div id="myModal" class="modal fade" role="dialog">
	<div class="modal-dialog">

		<!-- Modal content-->
		<div class="modal-content col-sm-8 col-md-offset-3">
			<form method="post" id="adduser" action="">
				<input type="hidden" id="csrfToken" name="${_csrf.parameterName}"
					value="${_csrf.token}" /> <input type="hidden" id="idUserNya"
					value="" />
				<div class="modal-header">
					<button type="button" class="close buttonClose"
						data-dismiss="modal">&times;</button>
					<h4 class="modal-title">
						Add new user
						<div id="infoSaveUser"></div>
					</h4>
				</div>
				<div class="modal-body">
					<div class="form-group">
						<div style="padding: 0px 0px 0px 3%;">
							<div class="row margin-bottom" style="width: 100%">
								<label class="control-label col-sm-3" style="padding-left: 1%">Username</label>
								<input class="col-sm-9" type="text" id="TextUsername"
									name="TextUsername" placeholder="Username">
							</div>
							<div class="row margin-bottom" style="width: 100%">
								<label class="control-label col-sm-3" style="padding-left: 1%">Password</label>
								<input class="col-sm-9" type="password" id="TextPassword"
									name="TextPassword" placeholder="Password">
							</div>
							<div class="row margin-bottom" style="width: 100%">
								<label class="control-label col-sm-3" style="padding-left: 1%">Name</label>
								<input class="col-sm-9" type="text" id="TextName"
									placeholder="Name">
							</div>
							<div class="row margin-bottom" style="width: 100%">
								<label class="control-label col-sm-3" style="padding-left: 1%">Email</label>
								<input class="col-sm-9" type="text" id="TextEmail"
									name="TextEmail" placeholder="Email">
							</div>
							<div class="row margin-bottom" style="width: 100%">
								<label class="control-label col-sm-3" style="padding-left: 1%">No
									Hp</label> <input class="col-sm-9" type="text" id="TextNoHp"
									name="TextNoHp" placeholder="No Hp">
							</div>
							<div class="row margin-bottom" style="width: 100%"
								id="select2RoleDiv">
								<label class="control-label col-sm-3" style="padding-left: 1%">Role</label>
								<select id="SelectRole" name="SelectRole"
									class="role-select2-multiple" multiple="multiple">



								</select>
							</div>
							<div class="row margin-bottom" style="width: 100%">
								<label class="control-label col-sm-3" style="padding-left: 1%">Is
									Active</label> <input id="CheckBoxIsActive" type="checkbox"
									style="position: initial">
							</div>
						</div>

					</div>
				</div>
				<div class="modal-footer">
					<button type="button" id="saveModalAddMenu" class="btn btn-default">Save</button>
					<button type="button" class="btn btn-default buttonClose"
						data-dismiss="modal">Close</button>
				</div>
			</form>
		</div>
	</div>
</div>

<script type="text/javascript">
	$(function() {
		$(".role-select2-multiple").select2({
			width : 75 + "%",
			maximumSelectionLength : 3
		});

		//http://www.texotela.co.uk/code/jquery/numeric/
		$("#TextNoHp").numeric();
		$("#adduser").validate({
			rules : {
				TextEmail : {
					required : true,
					email : true
				},
				TextUsername : {
					required : true
				},
				TextName : {
					required : true
				},
				TextNoHp : {
					required : true,
					minlength : 10,
					maxlength : 13
				},
				SelectRole : {
					required : true
				}
			}
		});

		var csrfToken = $('#csrfToken').val();
		//save user
		$("#saveModalAddMenu")
				.on(
						'click',
						function() {
							var textUsername, textName, textEmail, textNoHp, selectRole, checkBoxIsActive, textPassword, idUSerNya;
							textUsername = $("#TextUsername").val();
							textName = $("#TextName").val();
							textEmail = $("#TextEmail").val();
							textNoHp = $("#TextNoHp").val();
							selectRole = $("#SelectRole").val();
							textPassword = $("#TextPassword").val();
							checkBoxIsActive = $("#CheckBoxIsActive").is(
									':checked');
							idUSerNya = $("#idUserNya").val();
							$.ajax({
								type : 'POST',
								url : '/admin/v1/api/user/saveUser',
								headers : {
									'X-XSRF-TOKEN' : csrfToken
								},
								data : {
									textUserName : textUsername,
									textName : textName,
									textEmail : textEmail,
									textNoHp : textNoHp,
									selectRole : selectRole,
									checkBoxIsActive : checkBoxIsActive,
									textPassword : textPassword,
									idUSerNya : idUSerNya
								},
								datatype : 'json',
								success : function(data, textStatus, jqXHR) {
									removeModalInputUser();
									$("#infoSaveUser")
											.text("Save user success");
									//datatable reload
									$('#tableUser').DataTable().ajax.reload();
								},
								complete : function() {
								}
							});
						});

		function removeModalInputUser() {
			$("#TextUsername").val("");
			$("#TextName").val("");
			$("#TextEmail").val("");
			$("#TextNoHp").val("");
			$("#SelectRole").val("");
			$("#TextPassword").val("");
			$("#CheckBoxIsActive").is(':unchecked');
		}
		$(".buttonClose").on("click", function() {
			$("#infoSaveUser").text("");
		});

		//dataTables ajax logic
		$('#tableUser')
				.DataTable(
						{
							/*
							 * l - Length changing
							 f - Filtering input
							 t - The table!
							 i - Information
							 p - Pagination
							 r - pRocessing
							 < and > - div elements
							 <"class" and > - div with a class
							 Examples: <"wrapper"flipt>, <lf<t>ip>
							 */
							"sDom" : '<"top"fl>rt<"bottom"p><"clear">',
							serverSide : true,
							ordering : false,
							searching : true,
							ajax : function(data, callback, settings) {
								$
										.ajax({
											type : 'POST',
											url : '/admin/v1/api/user/list',
											headers : {
												'X-XSRF-TOKEN' : csrfToken
											},
											data : {
												limit : data.length,
												offset : data.start,
												search : data.search.value
											},
											dataType : "json",
											beforeSend : function() {

											},
											success : function(dataResponse,
													textStatus, jqXHR) {
												var out = [];
												var idUser = null;

												function buttonAction(i, idUser) {
													return '<input type = "hidden" name = "${_csrf.parameterName}" value = "${_csrf.token}" />'
															+ '<input type = "hidden" id = "idData' + idUser + '" class="idDataHide' + i + '" /> '
															+ '<button type = "submit" id = "editAuth' + i + '" class = "btn btn-primary editButton" > Edit </button> '
															+ '<button type = "submit" id = "deleteAuth' + i + '" class = "btn btn-primary deleteButton" > Delete </button>';
												}

												for (var i = 0, ien = dataResponse.listSysUserDto.length; i < ien; i++) {
													idUser = dataResponse.listSysUserDto[i].id;
													out
															.push([
																	i + 1,
																	dataResponse.listSysUserDto[i].id,
																	dataResponse.listSysUserDto[i].createdTime,
																	dataResponse.listSysUserDto[i].modifiedTime,
																	dataResponse.listSysUserDto[i].username,
																	dataResponse.listSysUserDto[i].name,
																	dataResponse.listSysUserDto[i].email,
																	dataResponse.listSysUserDto[i].noHp,
																	dataResponse.listSysUserDto[i].roleName,
																	dataResponse.listSysUserDto[i].isActive,
																	buttonAction(
																			i,
																			idUser) ]);
												}

												setTimeout(
														function() {
															callback({
																draw : data.draw,
																data : out,
																recordsTotal : dataResponse.totalRecord,
																recordsFiltered : dataResponse.totalRecord
															});
														}, 50);
											},
											complete : function() {
											},
											error : function(jqXHR, textStatus,
													errorThrown) {
											}
										});
							},
							scrollY : 360,
							scroller : {
								loadingIndicator : true
							}
						});

		$('#tableUser').on('search.dt', function() {
			var value = $('.dataTables_filter input').val();
		});

		var idUserForDelete = null;
		$("#tableUser").on(
				"click",
				".deleteButton",
				function() {
					//get value table with spesific tr and td
					//var val1 =$(t).find('tr:eq(2) td:eq(4)').text();            
					var idButtonDelete = $(this).attr("id").replace(
							"deleteAuth", "").trim();
					idUserForDelete = $(".idDataHide" + idButtonDelete).attr(
							"id");
					idUserForDelete = idUserForDelete.replace("idData", "")
							.trim();
					$("#modalDeleteUser").modal('show');
					//idData
				});

		$("#deleteUser").on("click", function() {
			if (idUserForDelete !== null) {
				deleteDataUser(idUserForDelete);
			}
			idUserForDelete = null;
		});

		function deleteDataUser(idMenu) {
			$.ajax({
				type : "DELETE",
				url : "/admin/v1/api/user/delete" + idMenu,
				headers : {
					'X-XSRF-TOKEN' : csrfToken
				},
				dataType : "json",
				success : function(data, textStatus, jqXHR) {
					//alert(data.id);
					//$('rowId'+data.id).remove();
					var tr = $('#rowId' + data.id).closest('tr');
					tr.css("background-color", "#00acd6");
					tr.fadeOut(400, function() {
						tr.remove();
					});
					$("#modalDeleteUser").modal('hide');
					$('#tableUser').DataTable().ajax.reload();
					return false;
				}
			});
		}

		getRoleList();
		function getRoleList() {
			$.get("/admin/v1/api/role/list", function(data) {
				for (var a = 0; a < data.length; a++) {
					$("#SelectRole").append(
							"<option value="+data[a].id+">" + data[a].roleName
									+ "</option>");
				}
			});
		}

		//get data from table
		$("#tableUser")
				.on(
						'click',
						'.editButton',
						function() {
							var idEditButton = $(this).attr('id');
							//disable button edit
							//$('#' + idEditButton).attr("disabled", true);
							var id = idEditButton.replace("editAuth", "");

							var textUserName, textName, textEmail, textNoHp, textSelectRole, textPassword, CheckBoxIsActive;

							//find the row
							var $row = $(this).closest("tr");
							var $tds = $row.find("td");
							var loopColumn = 1;

							//loop the column of per row
							$
									.each(
											$tds,
											function() {
												if (loopColumn === 2) {
													$("#idUserNya").val(
															$(this).text());
												}
												if (loopColumn === 5) {
													$("#TextUsername").val(
															$(this).text());
												} else if (loopColumn === 6) {
													$("#TextName").val(
															$(this).text());
												} else if (loopColumn === 7) {
													$("#TextEmail").val(
															$(this).text());
												} else if (loopColumn === 8) {
													$("#TextNoHp").val(
															$(this).text());
												} else if (loopColumn === 9) {
													//begin1 : get authorization and set to select2
													//
													//split data from table, example admin, approval, public 
													var test = $(this).text();
													var splitData = test
															.split(",");

													var mapSelect2 = {};
													for (var a = 0; a < splitData.length; a++) {
														mapSelect2[splitData[a]] = splitData[a];
													}

													var arrayTempVal = [];
													$('select#SelectRole')
															.find('option')
															.each(
																	function() {
																		var intNumberSelect2 = parseInt($(
																				this)
																				.val()) - 1;
																		var key;
																		for (key in mapSelect2) {
																			if ($(
																					this)
																					.text()
																					.trim() === key
																					.trim()) {
																				//get number for to set select2
																				//select2 just recieve val, not text
																				arrayTempVal
																						.push($(
																								this)
																								.val());
																			}
																		}
																	});
													$("#SelectRole").val(
															arrayTempVal)
															.trigger('change');
													//end1
												} else if (loopColumn === 10) {
													if ($(this).text().trim() === 'true') {
														$("#CheckBoxIsActive")
																.prop(
																		"checked",
																		true);
													} else {
														$("#CheckBoxIsActive")
																.prop(
																		'checked',
																		false);
													}
												}
												$("#TextPassword")
														.val("dummay");
												loopColumn += 1;
											});
							enableForm(id);
						});
		function enableForm(id) {
			$('#myModal').modal('show');
		}
	});
</script>
</body>
</html>
